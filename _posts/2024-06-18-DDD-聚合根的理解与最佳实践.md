---
title: DDD 聚合根的理解与最佳实践
date: 2024-06-18
tags: [DDD, 聚合根, 领域驱动设计, 仓储模式, 读写分离, ORM, 实体]
categories: [架构设计, 领域驱动设计]
---

## DDD 聚合根的理解与最佳实践

领域驱动设计（DDD, Domain Driven Design）倡导以业务为中心组织代码。在 DDD 中，“聚合根”（Aggregate Root）是业务建模的核心概念之一。本文结合个人理解，总结和扩展了几条关于聚合根的实践体会，并探讨其与分层架构、ORM、读写分离、仓储模式等系统设计要点之间的关系。

### 1. 聚合根的生命周期比 Entity 更长

在传统的分层架构中，“实体”（Entity）通常指与数据库表一一对应的业务对象，它的生命周期通常和数据库操作紧密相关。而在 DDD 中，聚合根的生存周期则更加长久和完整。聚合根不仅封装了一个事务边界内的所有业务规则、校验逻辑，还负责多个实体（Entity）与值对象（Value Object）的聚合与管理，同步维护状态变化。  

简言之，Entity 往往由数据库操作管理，其生命周期以数据库事务为边界；聚合根则服务于一次完整的业务操作流程（如一次业务请求）。

### 2. 聚合根比 Entity 更加抽象

实体（Entity）在 ORM（对象关系映射）层，主要承担数据库表映射和元数据跟踪角色。ORM 追踪实体变更，以实现统一的提交操作。聚合根则抽象为业务领域中的聚合节点，围绕它组织了一组业务相关的实体和值对象，并负责业务一致性。聚合根在领域层（Domain Layer）担任“业务事务总管”，远超单纯的数据库表映射器。

### 3. 聚合根不仅管理实体变化，更聚焦“业务副作用”

与 ORM 跟踪实体变更并统一上传数据库的机制类似，聚合根要负责追踪聚合内实体和值对象的状态变化。但更重要的是，聚合根要“记住”并统一管理业务副作用，例如领域事件的发布、领域服务的调用等。关键业务相关的变更，必须通过聚合根提供的业务方法完成。这一设计确保所有副作用都可以被正确地管理和触发，提升聚合的一致性和完整性。

最终一次性“上传”聚合状态（比如类比 ORM 的 `SaveChanges`），不仅需要更新所有实体，还要同步引发各种副作用，如领域事件、通知等，保证领域层对外的一致性承诺。

### 4. 聚合根的 Scope：一次请求生命周期

聚合根的“作用域”通常为一次业务请求（或业务过程）。一次聚合根的生命周期可以被抽象为下述步骤：

1. **创建聚合快照**：从仓储中加载或初始化聚合根实例；
2. **更改聚合**：业务执行中通过聚合根的方法修改其内部状态（从而产生副作用）；
3. **上传聚合**：通过仓储，一次性持久化所有变化，并触发需要的副作用（如领域事件的分发）。

这种聚合模式可以有效统摄一次业务过程，确保所有领域规则和副作用在聚合根内聚合，防止数据不一致和业务遗漏。

### 5. 读写分离与 DDD 的契合性

领域驱动设计强调实体间关系和业务完整性，但这也可能导致读操作构建过于“臃肿”的对象树。在大多数系统中，读取操作更倾向于查询并展示少量必要数据，此时无需完整构建聚合，特别是当一次查询涉及多表、多聚合对象时。

因此，DDD 与 CQRS（命令查询职责分离，常称“读写分离”）天然契合：  
- **写操作**：通过聚合根执行业务，确保一致性。
- **读操作**：直接通过数据库（如 `DbContext`）或只读仓储方法，获取所需的数据快照，无需聚合根即可满足需求。

这种分离使得业务代码更为清晰、性能更高、易扩展。

### 6. 聚合根和仓储模式的协作

DDD 推荐**仓储模式**（Repository Pattern）作为对聚合根数据持久化和重建的统一接口。仓储负责持久层与领域层的解耦，使领域开发者“只能”通过仓储访问聚合根（强制聚合边界）。这能有效阻止脏数据输入与不受控状态变更，保证所有聚合的生命周期和规则由领域层控制。

> 注意：在设计时要避免“贫血聚合”（仅包裹实体，缺少领域行为）和“过于庞大的聚合”（聚合根包含过多无关子对象）。聚合划分要以业务一致性边界和实际性能为权衡。

### 小结与实践建议

- 聚合根作为业务一致性边界，应该封装所有领域规则和重要数据状态。
- 聚合根的状态变更必须通过其业务方法进行，不能从外部直接操作子实体。
- 写操作用仓储加载/保存聚合，读操作可根据需要直接查询，少用完整聚合对象树。
- 仓储模式是 DDD 落地的必备实践，有助于聚合建构、生命周期维护和数据一致性。

DDD 聚合根的合理落地，可以显著提升大型业务系统的代码质量和业务演进能力。实际开发中，需结合项目规模、团队基础设施、性能需求等综合考虑，合理确定实体、聚合根及仓储的边界和实现细节。

---

**AI润色**